name: Ubuntu-TS-SSH

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server curl

      - name: Create user and enable SSH
        run: |
          sudo useradd -m -s /bin/bash rdp
          PASS="$(openssl rand -base64 18)"
          echo "rdp:$PASS" | sudo chpasswd
          sudo usermod -aG sudo rdp
          sudo systemctl enable --now ssh
          echo "SSH_USER=rdp" >> $GITHUB_ENV
          echo "SSH_PASS=$PASS" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}
          TS_IP="$(tailscale ip -4 | head -n1)"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Show access info
        run: |
          echo ""
          echo "=== SSH ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Port: 22"
          echo "Username: $SSH_USER"
          echo "Password: $SSH_PASS"
          echo "=================="
          echo ""

      - name: Maintain Connection
        run: |
          while true; do
            echo "[$(date)] SSH Active"
            sleep 300
          done
