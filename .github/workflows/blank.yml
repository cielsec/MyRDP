      - name: Create SSH user (Ubuntu Server) + enable SSH
        shell: bash
        run: |
          set -euo pipefail

          USER="sshuser"

          # senha: usa secret se existir, senão gera uma
          if [ -n "${{ secrets.SSH_PASSWORD }}" ]; then
            PASS="${{ secrets.SSH_PASSWORD }}"
          else
            PASS="$(python3 -c "import secrets,string; a=string.ascii_letters+string.digits+'@#$%^&*()_+=-{}[]:;,.?'; print(''.join(secrets.choice(a) for _ in range(28)))")"
          fi

          # instala SSH server
          sudo apt-get update
          sudo apt-get install -y openssh-server

          # cria usuário e seta senha
          sudo useradd -m -s /bin/bash "$USER" || true
          echo "$USER:$PASS" | sudo chpasswd
          sudo usermod -aG sudo "$USER" || true

          # configura sshd para permitir login por senha (se você preferir chave, me fala)
          sudo sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config

          # abre porta (no runner isso nem sempre é “necessário”, mas ok)
          sudo ufw allow 22/tcp || true
          sudo ufw --force enable || true

          # restart do ssh
          sudo systemctl enable ssh || true
          sudo systemctl restart ssh

          # exporta pro restante do workflow
          {
            echo "SSH_USER=$USER"
            echo "SSH_PASS=$PASS"
          } >> "$GITHUB_ENV"

          echo "SSH configurado. User: $USER"
