      - name: Bring up Tailscale + get IP (robusto)
        shell: bash
        run: |
          set -euo pipefail

          # Normaliza o authkey (remove \r e \n caso tenha vindo quebrado do Secrets)
          TS_AUTHKEY="$(printf '%s' "${{ secrets.TAILSCALE_AUTH_KEY }}" | tr -d '\r\n')"

          if [ -z "$TS_AUTHKEY" ]; then
            echo "ERRO: TAILSCALE_AUTH_KEY ficou vazio após normalização."
            exit 1
          fi

          # Garante daemon online
          sudo systemctl restart tailscaled || true
          sleep 2
          sudo tailscale status || true

          # Sobe com reset (evita config antiga) — sem --unattended
          sudo tailscale up \
            --reset \
            --authkey="$TS_AUTHKEY" \
            --hostname="gh-ubuntu-${{ github.run_id }}" \
            --accept-dns=false

          # Captura IP
          TSIP=""
          for i in {1..30}; do
            TSIP="$(tailscale ip -4 2>/dev/null | head -n1 || true)"
            [ -n "$TSIP" ] && break
            sleep 1
          done

          if [ -z "$TSIP" ]; then
            echo "ERRO: Tailscale não atribuiu IP."
            tailscale status || true
            exit 1
          fi

          echo "TAILSCALE_IP=$TSIP" >> "$GITHUB_ENV"
          echo "Tailscale IP: $TSIP"
