name: Ubuntu-SSH-Tailscale

on:
  workflow_dispatch:

concurrency:
  group: ubuntu-ssh
  cancel-in-progress: true

jobs:
  ubuntu-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Sanity check
        shell: bash
        run: |
          set -euo pipefail
          uname -a
          cat /etc/os-release
          whoami
          id

      - name: Install OpenSSH + create user (password login ON)
        shell: bash
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          set -euo pipefail
          USER="sshuser"

          if [ -n "${SSH_PASSWORD}" ]; then
            PASS="${SSH_PASSWORD}"
          else
            PASS="$(python3 -c "import secrets,string; a=string.ascii_letters+string.digits+'@#\$%^&*()_+=-{}[]:;,.?'; print(''.join(secrets.choice(a) for _ in range(28)))")"
          fi

          sudo apt-get update
          sudo apt-get install -y openssh-server curl jq netcat-openbsd ufw

          sudo useradd -m -s /bin/bash "$USER" || true
          echo "$USER:$PASS" | sudo chpasswd
          sudo usermod -aG sudo "$USER" || true

          sudo mkdir -p /etc/ssh/sshd_config.d
          echo "PasswordAuthentication yes" | sudo tee /etc/ssh/sshd_config.d/99-gh-actions.conf >/dev/null
          echo "KbdInteractiveAuthentication yes" | sudo tee -a /etc/ssh/sshd_config.d/99-gh-actions.conf >/dev/null
          echo "UsePAM yes" | sudo tee -a /etc/ssh/sshd_config.d/99-gh-actions.conf >/dev/null
          echo "PermitRootLogin no" | sudo tee -a /etc/ssh/sshd_config.d/99-gh-actions.conf >/dev/null

          sudo systemctl enable ssh
          sudo systemctl restart ssh

          echo "SSH_USER=$USER" >> "$GITHUB_ENV"
          echo "SSH_PASS=$PASS" >> "$GITHUB_ENV"

      - name: Install Tailscale
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled
          tailscale version

      - name: Tailscale up (AUTHKEY, non-interactive)
        shell: bash
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          set -euo pipefail

          if [ -z "${TS_AUTHKEY:-}" ]; then
            echo "ERRO: defina o secret TS_AUTHKEY no repo."
            exit 1
          fi

          sudo tailscale up --reset --authkey "$TS_AUTHKEY" --hostname "gh-ubuntu-${{ github.run_id }}" --accept-dns=false

          for i in $(seq 1 60); do
            ONLINE="$(tailscale status --json | jq -r '.Self.Online')"
            if [ "$ONLINE" = "true" ]; then
              break
            fi
            echo "Aguardando Tailscale ficar Online... ($i/60)"
            sleep 1
          done

          ONLINE="$(tailscale status --json | jq -r '.Self.Online')"
          if [ "$ONLINE" != "true" ]; then
            echo "ERRO: Tailscale não ficou Online."
            tailscale status || true
            exit 1
          fi

          TSIP="$(tailscale ip -4 | head -n1)"
          if [ -z "$TSIP" ]; then
            echo "ERRO: Online, mas sem IPv4."
            tailscale status || true
            exit 1
          fi

          echo "TAILSCALE_IP=$TSIP" >> "$GITHUB_ENV"

      - name: Firewall - allow SSH only via tailscale0
        shell: bash
        run: |
          set -euo pipefail
          sudo ufw --force reset
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow in on tailscale0 to any port 22 proto tcp
          sudo ufw --force enable
          sudo ufw status verbose

      - name: Validate services
        shell: bash
        run: |
          set -euo pipefail
          echo "--- SSHD status ---"
          sudo systemctl --no-pager -l status ssh
          echo "--- Listening ports ---"
          sudo ss -lntp | grep -E ":(22)\b" || (echo "ERRO: sshd não está ouvindo na 22" && exit 1)
          echo "--- Local connect test (localhost:22) ---"
          nc -vz 127.0.0.1 22 || true
          echo "--- Tailscale status (resumo) ---"
          tailscale status --json | jq '{BackendState: .BackendState, Online: .Self.Online, DNSName: .Self.DNSName, TailscaleIPs: .Self.TailscaleIPs}'

      - name: Show access info
        shell: bash
        run: |
          set -euo pipefail
          echo ""
          echo "=============================="
          echo "SSH ACCESS (OpenSSH via Tailscale IP)"
          echo "Host: $TAILSCALE_IP"
          echo "User: $SSH_USER"
          echo "Pass: $SSH_PASS"
          echo ""
          echo "No seu PC:"
          echo "ssh $SSH_USER@$TAILSCALE_IP"
          echo "=============================="
          echo ""

      - name: Install and start tmate
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y tmate
          tmate -F
